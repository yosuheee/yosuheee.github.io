ポリゴンを線分で表示したいときにどうするか。ポリゴンの三角形情報を線分情報に変換する必要がある。そして、描画するときに呼び出す関数が `drawArrays(gl.LINES, ...)` のようになる。

`Line` クラスと `LineModel` クラスを作った。`Polygon` クラスや `Model` クラスに酷似しているので、いずれ共通化していきたい。でもその前に、`Polygon` を `Line` に変換する関数を作成したい。

【処理系によって異なる部分】

| 分類 | A | B |
|---|---|---|
| 座標系 | 右手座標系（RH） | 左手座標系（LH） |
| 描画される z の範囲 | $[-1, 1]$ | $[0, 1]$ |
| カメラの向き | $(0, 0, -1)$ | $(0, 0, 1)$ |
| ベクトルの記法 | 縦ベクトル | 横ベクトル |

※ OpenGL/DirectX 系という分類には2つの流儀がある（実際はもっとあるかも）。「描画される z の範囲が $[0, 1]$ であれば DirectX 系」と「左手座標系で、かつ描画される z の範囲が $[0, 1]$ であれば DirectX 系」。今回は混乱を避けるため、OpenGL/DirectX 系という分類は用いない

【処理系が異なっていても同じ部分】

* カメラの位置は $(0, 0, 0)$
* カメラの上方向は $(0, 1, 0)$
* 行列変換後のベクトルの全成分を第四成分で割る（ただし第四成分が $0$ の場合は割らない）

それぞれの選択を行うことで、パースペクティブ射影変換のときに用いる行列がどうなるかは自ずと導き出せる。glMatrix の場合は「右手座標系」「$[-1, 1]$」「$(0, 0, -1)$」「縦ベクトル」を選択している。これは OpenGL の API と一致する。

パースペクティブ射影変換の行列は、次の順序で求める。

1. 縦横比を $1 : 1$ にする。具体的には、台の横縦比が $W : H$ である場合、$x$ を $H / W$ 倍する
2. 視野角を $90^\circ$ にする。具体的には、$x$ と $y$ を $\cot(\theta / 2)$ 倍する
3. 原点から、近いほうの台までの距離を $n$ 、遠いほうの台までの距離を $f$ としたとき（カメラの位置は $(0, 0, 0)$ 、カメラの向きは $(0, 0, -1)$ であるため $n, f \lt 0$ を満たす）、視錐台を $(0, 0, -(n + f) / 2)$ 動かす
4. 視錐台を $z$ 方向に $2 / (n - f)$ 倍（$n, f \lt 0$ であることを忘れずに）する

とりあえず、ここまでの順序をすべて行列に変換して掛け合わせる。

ようやく OpenGL のパースペクティブ射影変換行列の10番目と14番目の要素の意味が分かった。これはただ単に連立方程式を解いた結果だった。これはどこかで情報共有しておきたいな。

上の $n, f$ の定義は glMatrix と異なる。これは定義なのでどちらで話を進めても最終的に求まる式は正しくなるけど、どうせなら正しさを確認できるように glMatrix で式の算出を行いたい。ということで、$n, f \le 0$ ではなく $n, f \ge 0$ とする。glMatrix の `mat4.perspective(out, fovy, aspect, near, far)` の `near` と `far` が、まさに $n$ と $f$ に対応する。「$n$ と $f$ が非負整数なのにカメラの向きは $(0, 0, -1)$ だよね？これってどういうこと？」という感じだけど、単に視錐台の手前の台の面と $z$ 軸との交点を $(0, 0, -n)$ と定義し、奥の台の面と $z$ 軸との交点を $(0, 0, -f)$ と定義するだけのことだ。これは定義の問題なので「なぜそのような定義にするか」と問う意味はない。

これまでの定義をまとめる。

* 座標系は右手座標系とする
* 描画する $z$ の範囲は $[-1, 1]$ とする
* カメラの位置、向き、上向きは $(0, 0, 0), (0, 0, -1), (0, 1, 0)$ とする
* ベクトルは縦ベクトルとする
* 視野角を $\theta$ とおく
* 視錐台の手前の台と $z$ 軸との交点を $(0, 0, -n)$ とおく
* 視錐台の奥の台と $z$ 軸との交点を $(0, 0, -f)$ とおく

これでようやく話を進められる。この定義は glMatrix と完全に一致する。

どのように視錐台の範囲を $-1 \le x, y, z \le 1$ の立方体の範囲に変換するか、改めて掲載する。次の変換手順を行う。

1. 横縦比を $1 : 1$ にする。これをすることにより、$z$ が同じであれば $x = y$ を満たすため、以降扱いやすくなる。$y$ に行った変換を $x$ にもしてやればいいというわけだ。横縦比を $1 : 1$ にするために、$x$ をアスペクト比で割る。なぜ $y$ にアスペクト比を掛けるのではなく $x$ をアスペクト比で割るのかについては考えてはいけない。先人が $x$ をアスペクト比で割りたい気分だっただけだ
2. 視錐台の形を直方体の形にする。
